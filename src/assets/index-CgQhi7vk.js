(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();class y{constructor(){this.currentTheme="dark",this.init()}init(){const e=localStorage.getItem("teleprompter-theme");e&&this.setTheme(e)}toggleTheme(){const e=this.currentTheme==="dark"?"light":"dark";this.setTheme(e)}setTheme(e){this.currentTheme=e,document.body.classList.remove("dark-theme","light-theme"),document.body.classList.add(`${e}-theme`),this.updateThemeButton(),this.updateTextColor(),localStorage.setItem("teleprompter-theme",e),this.dispatchThemeChange(e)}updateThemeButton(){const e=document.getElementById("themeBtn"),t=e.querySelector("img");this.currentTheme==="dark"?(t.src="images/sun.svg",e.title="切换到浅色模式"):(t.src="images/moon.svg",e.title="切换到深色模式")}updateTextColor(){const e=document.getElementById("textEditor"),t=document.getElementById("fontColor");this.currentTheme==="dark"?(!t.value||t.value==="#333333")&&(t.value="#ffffff",e.style.color="#ffffff"):(!t.value||t.value==="#ffffff")&&(t.value="#333333",e.style.color="#333333")}dispatchThemeChange(e){const t=new CustomEvent("themeChanged",{detail:{theme:e}});document.dispatchEvent(t)}getCurrentTheme(){return this.currentTheme}isDarkTheme(){return this.currentTheme==="dark"}isLightTheme(){return this.currentTheme==="light"}}class S{constructor(){this.isAutoScrolling=!1,this.scrollSpeed=30,this.scrollType="line",this.scrollInterval=null,this.totalDuration=10,this.autoCalculateDuration=!1,this.currentScrollPosition=0,this.targetScrollPosition=0,this.smoothScrollFrame=null,this.init()}init(){this.setupScrollSettings(),this.updateReadingLine()}setupScrollSettings(){const e=document.getElementById("autoScroll"),t=document.getElementById("autoScrollOptions"),n=document.getElementById("scrollType"),o=document.getElementById("scrollSpeed"),i=document.getElementById("scrollSpeedValue"),l=document.getElementById("autoDuration"),r=document.getElementById("durationSettings"),s=document.getElementById("totalDuration");e.addEventListener("change",()=>{e.checked?t.style.display="block":(t.style.display="none",this.stopAutoScroll())}),n.addEventListener("change",()=>{this.scrollType=n.value,this.autoCalculateDuration&&this.calculateOptimalSpeed()}),o.addEventListener("input",()=>{this.scrollSpeed=parseInt(o.value),i.textContent=this.scrollSpeed}),l.addEventListener("change",()=>{this.autoCalculateDuration=l.checked,l.checked?(r.style.display="block",this.calculateOptimalSpeed()):r.style.display="none"}),s.addEventListener("input",()=>{this.totalDuration=parseInt(s.value),this.autoCalculateDuration&&this.calculateOptimalSpeed()})}startAutoScroll(){if(this.isAutoScrolling||!document.getElementById("autoScroll").checked)return;this.isAutoScrolling=!0;const t=document.getElementById("textEditor");this.currentScrollPosition=t.scrollTop,this.smoothAutoScroll()}smoothAutoScroll(){if(!this.isAutoScrolling)return;const e=document.getElementById("textEditor"),t=e.scrollHeight-e.clientHeight;if(this.currentScrollPosition>=t){this.stopAutoScroll();return}const n=this.calculateScrollStep();this.currentScrollPosition+=n,e.scrollTop=this.currentScrollPosition,this.updateReadingLine(),window.app&&window.app.updateScrollbar&&window.app.updateScrollbar(),this.smoothScrollFrame=requestAnimationFrame(()=>{this.smoothAutoScroll()})}calculateScrollStep(){const e=this.scrollSpeed/100;if(this.scrollType==="line"){const t=document.getElementById("textEditor");return(parseInt(window.getComputedStyle(t).lineHeight)||24)*e/60}else return e*2}stopAutoScroll(){this.isAutoScrolling=!1,this.smoothScrollFrame&&(cancelAnimationFrame(this.smoothScrollFrame),this.smoothScrollFrame=null)}calculateOptimalSpeed(){const t=document.getElementById("textEditor").textContent;let n;this.scrollType==="line"?n=t.split(`
`).length:n=t.length;const o=this.totalDuration*60,i=Math.round(n/o*10);this.scrollSpeed=Math.max(1,Math.min(100,i));const l=document.getElementById("scrollSpeed"),r=document.getElementById("scrollSpeedValue");l.value=this.scrollSpeed,r.textContent=this.scrollSpeed}updateReadingLine(){const e=document.getElementById("textEditor");document.getElementById("readingLine");const t=e.scrollTop/(e.scrollHeight-e.clientHeight),n=e.textContent.split(`
`).length,o=Math.floor(t*n);this.highlightCurrentLine(o)}highlightCurrentLine(e){document.getElementById("textEditor").textContent.split(`
`)}scrollToPosition(e){const t=document.getElementById("textEditor"),n=e*(t.scrollHeight-t.clientHeight);this.smoothScrollTo(n)}smoothScrollTo(e){const t=document.getElementById("textEditor"),n=t.scrollTop,o=e-n,i=500;let l=null;const r=s=>{l===null&&(l=s);const c=s-l,d=Math.min(c/i,1),g=d<.5?2*d*d:1-Math.pow(-2*d+2,2)/2;t.scrollTop=n+o*g,d<1?requestAnimationFrame(r):(this.updateReadingLine(),window.app&&window.app.updateScrollbar&&window.app.updateScrollbar())};requestAnimationFrame(r)}getScrollProgress(){const e=document.getElementById("textEditor");return e.scrollTop/(e.scrollHeight-e.clientHeight)}}class w{constructor(){this.init()}init(){this.setupTextEditor()}setupTextEditor(){const e=document.getElementById("textEditor");e.addEventListener("input",()=>{this.onTextChange()}),e.addEventListener("paste",t=>{this.handlePaste(t)}),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("drag-over"),this.handleFileDrop(t)}),window.addEventListener("resize",()=>{this.preserveTextFormat()})}handleFileImport(e){const t=e.target.files[0];if(!t)return;if(!t.name.toLowerCase().endsWith(".txt")){alert("请选择.txt格式的文本文件");return}const n=new FileReader;n.onload=o=>{const i=o.target.result;this.setText(i)},n.readAsText(t,"utf-8")}handleFileDrop(e){const t=e.dataTransfer.files;if(t.length>0){const n=t[0];if(n.name.toLowerCase().endsWith(".txt")){const o=new FileReader;o.onload=i=>{const l=i.target.result;this.setText(l)},o.readAsText(n,"utf-8")}else alert("请拖拽.txt格式的文本文件")}}handlePaste(e){e.preventDefault();const n=(e.clipboardData||window.clipboardData).getData("text").replace(/\r\n/g,`
`).replace(/\r/g,`
`),o=window.getSelection();if(o.rangeCount>0){const i=o.getRangeAt(0);i.deleteContents();const l=n.split(`
`);for(let r=0;r<l.length;r++)r>0&&i.insertNode(document.createElement("br")),l[r]&&i.insertNode(document.createTextNode(l[r]));i.collapse(!1),o.removeAllRanges(),o.addRange(i)}this.onTextChange()}setText(e){const t=document.getElementById("textEditor"),o=e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`);t.innerHTML="";for(let i=0;i<o.length;i++)i>0&&t.appendChild(document.createElement("br")),o[i]&&t.appendChild(document.createTextNode(o[i]));this.onTextChange()}getText(){const e=document.getElementById("textEditor");return e.innerText||e.textContent}preserveTextFormat(){document.getElementById("textEditor");const e=this.getText();setTimeout(()=>{this.setText(e)},100)}onTextChange(){window.app&&window.app.updateScrollbar&&setTimeout(()=>window.app.updateScrollbar(),100),window.scrollController&&window.scrollController.autoCalculateDuration&&window.scrollController.calculateOptimalSpeed(),this.saveToLocalStorage()}saveToLocalStorage(){const e=this.getText();localStorage.setItem("teleprompter-text",e)}loadFromLocalStorage(){const e=localStorage.getItem("teleprompter-text");return e?(this.setText(e),!0):!1}exportText(){const e=this.getText(),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`teleprompter-text-${new Date().toISOString().slice(0,10)}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}clearText(){confirm("确定要清空所有文本吗？")&&this.setText("")}insertAtCursor(e){const t=document.getElementById("textEditor"),n=window.getSelection();if(n.rangeCount>0){const o=n.getRangeAt(0);o.deleteContents(),o.insertNode(document.createTextNode(e)),o.collapse(!1)}else t.appendChild(document.createTextNode(e));this.onTextChange()}getWordCount(){const e=this.getText();return{characters:e.length,charactersNoSpaces:e.replace(/\s/g,"").length,words:e.trim().split(/\s+/).filter(t=>t.length>0).length,lines:e.split(`
`).length,paragraphs:e.split(/\n\s*\n/).filter(t=>t.trim().length>0).length}}}class E{constructor(){this.mediaRecorder=null,this.audioChunks=[],this.isRecording=!1,this.audioBlob=null,this.audioUrl=null,this.recognition=null,this.init()}init(){this.setupRecordingControls(),this.initializeSpeechRecognition()}setupRecordingControls(){const e=document.getElementById("startRecord"),t=document.getElementById("stopRecord"),n=document.getElementById("playRecord"),o=document.getElementById("audioSync");e.addEventListener("click",()=>{this.startRecording()}),t.addEventListener("click",()=>{this.stopRecording()}),n.addEventListener("click",()=>{this.playRecording()}),o.addEventListener("change",()=>{this.toggleAudioSync(o.checked)}),this.setupAudioPlayerModal()}async startRecording(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});this.mediaRecorder=new MediaRecorder(e),this.audioChunks=[],this.mediaRecorder.ondataavailable=t=>{this.audioChunks.push(t.data)},this.mediaRecorder.onstop=()=>{this.audioBlob=new Blob(this.audioChunks,{type:"audio/wav"}),this.audioUrl=URL.createObjectURL(this.audioBlob),this.updateRecordingControls()},this.mediaRecorder.start(),this.isRecording=!0,this.updateRecordingControls(),document.getElementById("audioSync").checked&&this.startSpeechRecognition()}catch(e){console.error("录音失败:",e),alert("无法访问麦克风，请检查权限设置")}}stopRecording(){this.mediaRecorder&&this.isRecording&&(this.mediaRecorder.stop(),this.mediaRecorder.stream.getTracks().forEach(e=>e.stop()),this.isRecording=!1,this.recognition&&this.recognition.stop())}playRecording(){this.audioUrl&&this.showAudioPlayerModal()}updateRecordingControls(){const e=document.getElementById("startRecord"),t=document.getElementById("stopRecord"),n=document.getElementById("playRecord");this.isRecording?(e.disabled=!0,t.disabled=!1,n.disabled=!0,e.textContent="录音中...",e.style.background="#dc3545"):(e.disabled=!1,t.disabled=!0,e.textContent="开始录音",e.style.background="#007bff",this.audioUrl&&(n.disabled=!1))}initializeSpeechRecognition(){if("webkitSpeechRecognition"in window)this.recognition=new webkitSpeechRecognition;else if("SpeechRecognition"in window)this.recognition=new SpeechRecognition;else{console.warn("当前浏览器不支持语音识别功能");return}this.recognition&&(this.recognition.lang="zh-CN",this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.onresult=e=>{this.handleSpeechResult(e)},this.recognition.onerror=e=>{console.error("语音识别错误:",e.error)})}startSpeechRecognition(){this.recognition&&this.recognition.start()}handleSpeechResult(e){const t=e.results[e.results.length-1];if(t.isFinal){const n=t[0].transcript;this.syncScrollWithSpeech(n)}}syncScrollWithSpeech(e){const n=document.getElementById("textEditor").textContent,o=n.indexOf(e.trim());if(o!==-1){const l=n.substring(0,o).split(`
`).length,r=n.split(`
`).length,s=l/r;window.scrollController&&window.scrollController.scrollToPosition(s)}}toggleAudioSync(e){e&&this.recognition?console.log("音频智能识别滚动已启用"):console.log("音频智能识别滚动已禁用")}setupAudioPlayerModal(){const e=document.getElementById("audioPlayerModal"),t=document.getElementById("closeAudioPlayer"),n=document.getElementById("replayAudio"),o=document.getElementById("downloadAudio"),i=document.getElementById("audioPlayer");t.addEventListener("click",()=>{this.hideAudioPlayerModal()}),e.addEventListener("click",l=>{l.target===e&&this.hideAudioPlayerModal()}),n.addEventListener("click",()=>{i.currentTime=0,i.play()}),o.addEventListener("click",()=>{if(this.audioBlob){const l=URL.createObjectURL(this.audioBlob),r=document.createElement("a");r.href=l,r.download=`teleprompter-recording-${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.wav`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(l)}}),i.addEventListener("loadedmetadata",()=>{this.updateAudioInfo()}),document.addEventListener("keydown",l=>{l.key==="Escape"&&e.style.display==="block"&&this.hideAudioPlayerModal()})}showAudioPlayerModal(){const e=document.getElementById("audioPlayerModal"),t=document.getElementById("audioPlayer");t.src=this.audioUrl,e.style.display="flex",this.updateAudioInfo()}hideAudioPlayerModal(){const e=document.getElementById("audioPlayerModal");document.getElementById("audioPlayer").pause(),e.style.display="none"}updateAudioInfo(){const e=document.getElementById("audioPlayer"),t=document.getElementById("audioFileName"),n=document.getElementById("audioDuration"),o=new Date,i=`录音-${o.toLocaleDateString()}-${o.toLocaleTimeString()}`;if(t.textContent=i,e.duration&&!isNaN(e.duration)){const l=Math.floor(e.duration/60),r=Math.floor(e.duration%60);n.textContent=`${l.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}else n.textContent="--:--"}}class v{constructor(){this.init()}init(){this.setupFontSettings(),this.loadSettings()}setupFontSettings(){const e=document.getElementById("fontFamily"),t=document.getElementById("fontSize"),n=document.getElementById("fontSizeValue"),o=document.getElementById("fontColor"),i=document.getElementById("marginLeft"),l=document.getElementById("marginLeftValue"),r=document.getElementById("marginRight"),s=document.getElementById("marginRightValue"),c=document.getElementById("letterSpacing"),d=document.getElementById("letterSpacingValue"),g=document.getElementById("lineHeight"),h=document.getElementById("lineHeightValue"),m=document.getElementById("textEditor");e.addEventListener("change",()=>{m.style.fontFamily=e.value,this.saveSettings()}),t.addEventListener("input",()=>{const a=t.value+"px";m.style.fontSize=a,n.textContent=a,this.saveSettings()}),o.addEventListener("input",()=>{m.style.color=o.value,this.saveSettings()}),i.addEventListener("input",()=>{const a=i.value+"px";m.style.paddingLeft=a,l.textContent=a,this.saveSettings()}),r.addEventListener("input",()=>{const a=r.value+"px";m.style.paddingRight=a,s.textContent=a,this.saveSettings()}),c.addEventListener("input",()=>{const a=c.value+"px";m.style.letterSpacing=a,d.textContent=a,this.saveSettings()}),g.addEventListener("input",()=>{const a=g.value;m.style.lineHeight=a,h.textContent=a,this.saveSettings()})}saveSettings(){var t,n,o,i,l;const e={fontFamily:document.getElementById("fontFamily").value,fontSize:document.getElementById("fontSize").value,fontColor:document.getElementById("fontColor").value,marginLeft:document.getElementById("marginLeft").value,marginRight:document.getElementById("marginRight").value,letterSpacing:document.getElementById("letterSpacing").value,lineHeight:document.getElementById("lineHeight").value,autoScroll:document.getElementById("autoScroll").checked,scrollType:document.getElementById("scrollType").value,scrollSpeed:document.getElementById("scrollSpeed").value,horizontalFlip:((t=document.getElementById("horizontalFlip"))==null?void 0:t.checked)||!1,verticalFlip:((n=document.getElementById("verticalFlip"))==null?void 0:n.checked)||!1,watermarkEnabled:((o=document.getElementById("watermarkEnabled"))==null?void 0:o.checked)||!1,watermarkText:((i=document.getElementById("watermarkText"))==null?void 0:i.value)||"",watermarkType:((l=document.getElementById("watermarkType"))==null?void 0:l.value)||"center"};localStorage.setItem("teleprompter-settings",JSON.stringify(e))}loadSettings(){const e=localStorage.getItem("teleprompter-settings");if(!e){this.applyDefaultSettings();return}try{const t=JSON.parse(e);this.applySettings(t)}catch(t){console.error("加载设置失败:",t),this.applyDefaultSettings()}}applyDefaultSettings(){var t;const e={fontFamily:"SimSun, serif",fontSize:40,fontColor:(t=window.themeController)!=null&&t.isDarkTheme()?"#ffffff":"#333333",marginLeft:100,marginRight:50,letterSpacing:1,lineHeight:1.6,autoScroll:!0,scrollType:"line",scrollSpeed:10,horizontalFlip:!1,verticalFlip:!1,watermarkEnabled:!1,watermarkText:"",watermarkType:"center"};this.applySettings(e)}applySettings(e){const t=document.getElementById("textEditor");e.fontFamily&&(document.getElementById("fontFamily").value=e.fontFamily,t.style.fontFamily=e.fontFamily),e.fontSize&&(document.getElementById("fontSize").value=e.fontSize,document.getElementById("fontSizeValue").textContent=e.fontSize+"px",t.style.fontSize=e.fontSize+"px"),e.fontColor&&(document.getElementById("fontColor").value=e.fontColor,t.style.color=e.fontColor),e.marginLeft!==void 0&&(document.getElementById("marginLeft").value=e.marginLeft,document.getElementById("marginLeftValue").textContent=e.marginLeft+"px",t.style.paddingLeft=e.marginLeft+"px"),e.marginRight!==void 0&&(document.getElementById("marginRight").value=e.marginRight,document.getElementById("marginRightValue").textContent=e.marginRight+"px",t.style.paddingRight=e.marginRight+"px"),e.letterSpacing!==void 0&&(document.getElementById("letterSpacing").value=e.letterSpacing,document.getElementById("letterSpacingValue").textContent=e.letterSpacing+"px",t.style.letterSpacing=e.letterSpacing+"px"),e.lineHeight!==void 0&&(document.getElementById("lineHeight").value=e.lineHeight,document.getElementById("lineHeightValue").textContent=e.lineHeight,t.style.lineHeight=e.lineHeight),e.autoScroll!==void 0&&(document.getElementById("autoScroll").checked=e.autoScroll),e.scrollType&&(document.getElementById("scrollType").value=e.scrollType),e.scrollSpeed!==void 0&&(document.getElementById("scrollSpeed").value=e.scrollSpeed,document.getElementById("scrollSpeedValue").textContent=e.scrollSpeed),e.horizontalFlip!==void 0&&document.getElementById("horizontalFlip")&&(document.getElementById("horizontalFlip").checked=e.horizontalFlip),e.verticalFlip!==void 0&&document.getElementById("verticalFlip")&&(document.getElementById("verticalFlip").checked=e.verticalFlip),e.watermarkEnabled!==void 0&&document.getElementById("watermarkEnabled")&&(document.getElementById("watermarkEnabled").checked=e.watermarkEnabled),e.watermarkText&&document.getElementById("watermarkText")&&(document.getElementById("watermarkText").value=e.watermarkText),e.watermarkType&&document.getElementById("watermarkType")&&(document.getElementById("watermarkType").value=e.watermarkType)}resetSettings(){confirm("确定要重置所有设置吗？")&&(localStorage.removeItem("teleprompter-settings"),this.applyDefaultSettings())}exportSettings(){const e=localStorage.getItem("teleprompter-settings");if(e){const t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`teleprompter-settings-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}}importSettings(e){const t=new FileReader;t.onload=n=>{try{const o=JSON.parse(n.target.result);this.applySettings(o),this.saveSettings(),alert("设置导入成功！")}catch{alert("设置文件格式错误！")}},t.readAsText(e)}}class B{constructor(){this.init()}init(){this.setupWatermarkControls()}setupWatermarkControls(){const e=document.getElementById("watermarkEnabled"),t=document.getElementById("watermarkOptions"),n=document.getElementById("watermarkText"),o=document.getElementById("watermarkType");e.addEventListener("change",()=>{e.checked?(t.style.display="block",this.showWatermark()):(t.style.display="none",this.hideWatermark()),this.saveSettings()}),n.addEventListener("input",()=>{this.updateWatermark(),this.saveSettings()}),o.addEventListener("change",()=>{this.updateWatermark(),this.saveSettings()})}showWatermark(){const e=document.getElementById("watermarkLayer");e.style.display="block",this.updateWatermark()}hideWatermark(){const e=document.getElementById("watermarkLayer");e.style.display="none",e.innerHTML=""}updateWatermark(){if(!document.getElementById("watermarkEnabled").checked)return;const t=document.getElementById("watermarkText").value,n=document.getElementById("watermarkType").value,o=document.getElementById("watermarkLayer");if(!t.trim()){o.innerHTML="";return}n==="center"?this.createCenterWatermark(t,o):this.createDiagonalWatermark(t,o)}createCenterWatermark(e,t){t.innerHTML="";const n=document.createElement("div");n.textContent=e,n.style.cssText=`
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: rgba(128, 128, 128, 0.1);
            white-space: nowrap;
            pointer-events: none;
            z-index: 50;
            user-select: none;
        `,t.appendChild(n)}createDiagonalWatermark(e,t){t.innerHTML="";const n=t.getBoundingClientRect(),o=Math.ceil(n.height/150),i=Math.ceil(n.width/300);for(let l=0;l<o;l++)for(let r=0;r<i;r++){const s=document.createElement("div");s.textContent=e,s.style.cssText=`
                    position: absolute;
                    top: ${l*150+75}px;
                    left: ${r*300+150}px;
                    transform: translate(-50%, -50%) rotate(-45deg);
                    font-size: 24px;
                    font-weight: normal;
                    color: rgba(128, 128, 128, 0.08);
                    white-space: nowrap;
                    pointer-events: none;
                    z-index: 50;
                    user-select: none;
                `,t.appendChild(s)}}saveSettings(){window.settingsController&&window.settingsController.saveSettings()}}class I{constructor(){this.init()}init(){this.setupFlipControls()}setupFlipControls(){const e=document.getElementById("horizontalFlip"),t=document.getElementById("verticalFlip");e.addEventListener("change",()=>{this.updateFlip(),this.saveSettings()}),t.addEventListener("change",()=>{this.updateFlip(),this.saveSettings()})}updateFlip(){const e=document.getElementById("textEditor"),t=document.getElementById("horizontalFlip").checked,n=document.getElementById("verticalFlip").checked;e.classList.remove("flipped-horizontal","flipped-vertical","flipped-both"),t&&n?e.classList.add("flipped-both"):t?e.classList.add("flipped-horizontal"):n&&e.classList.add("flipped-vertical"),this.applyFlipTransform(t,n)}applyFlipTransform(e,t){const n=document.getElementById("textEditor");let o="";e&&t?o="scale(-1, -1)":e?o="scaleX(-1)":t?o="scaleY(-1)":o="none",n.style.transform=o}saveSettings(){window.settingsController&&window.settingsController.saveSettings()}resetFlip(){document.getElementById("horizontalFlip").checked=!1,document.getElementById("verticalFlip").checked=!1,this.updateFlip(),this.saveSettings()}}class T{constructor(){this.readingLine=document.getElementById("readingLine"),this.isDragging=!1,this.startY=0,this.startTop=0,this.defaultPosition=25,this.init()}init(){this.readingLine&&(this.readingLine.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),this.readingLine.addEventListener("touchstart",this.onTouchStart.bind(this)),document.addEventListener("touchmove",this.onTouchMove.bind(this)),document.addEventListener("touchend",this.onTouchEnd.bind(this)),this.readingLine.addEventListener("dblclick",this.resetPosition.bind(this)))}onMouseDown(e){e.preventDefault(),this.startDrag(e.clientY)}onTouchStart(e){e.preventDefault(),this.startDrag(e.touches[0].clientY)}startDrag(e){this.isDragging=!0,this.startY=e;const n=window.getComputedStyle(this.readingLine).top;if(n.includes("%"))this.startTop=parseFloat(n);else{const o=parseFloat(n);this.startTop=o/window.innerHeight*100}this.readingLine.classList.add("dragging"),document.body.style.userSelect="none"}onMouseMove(e){this.isDragging&&this.updatePosition(e.clientY)}onTouchMove(e){this.isDragging&&(e.preventDefault(),this.updatePosition(e.touches[0].clientY))}updatePosition(e){const n=(e-this.startY)/window.innerHeight*100;let o=this.startTop+n;o=Math.max(5,Math.min(95,o)),this.readingLine.style.top=o+"%"}onMouseUp(){this.endDrag()}onTouchEnd(){this.endDrag()}endDrag(){this.isDragging&&(this.isDragging=!1,this.readingLine.classList.remove("dragging"),document.body.style.userSelect="",this.savePosition())}resetPosition(){this.readingLine.style.top=this.defaultPosition+"%",this.savePosition()}savePosition(){const e=window.getComputedStyle(this.readingLine).top;let t;e.includes("%")?t=parseFloat(e):t=parseFloat(e)/window.innerHeight*100,localStorage.setItem("readingLinePosition",t.toString())}loadPosition(){const e=localStorage.getItem("readingLinePosition");if(e){const t=parseFloat(e);if(t>=5&&t<=95){this.readingLine.style.top=t+"%";return}}this.readingLine.style.top=this.defaultPosition+"%"}getCurrentPosition(){const e=window.getComputedStyle(this.readingLine).top;return e.includes("%")?parseFloat(e):parseFloat(e)/window.innerHeight*100}}class x{constructor(){this.isPlaying=!1,this.isLocked=!1,this.currentSettings=this.getDefaultSettings(),this.scrollController=null,this.activePanel=null,this.sidebarHidden=!1,this.countdownDuration=0,this.init()}init(){window.themeController=new y,window.scrollController=new S,window.textController=new w,window.audioController=new E,window.settingsController=new v,window.watermarkController=new B,window.flipController=new I,window.draggableLine=new T,window.draggableLine.loadPosition(),this.setupEventListeners(),this.loadDefaultText(),this.updateTimeDisplay(),this.initializeScrollbar(),this.setupSidebarBehavior(),setInterval(()=>this.updateTimeDisplay(),1e3)}getDefaultSettings(){return{theme:"dark",fontSize:40,fontFamily:"SimSun, serif",fontColor:"#ffffff",marginLeft:100,marginRight:50,letterSpacing:1,lineHeight:1.6,autoScroll:!0,scrollType:"line",scrollSpeed:10,horizontalFlip:!1,verticalFlip:!1,watermarkEnabled:!1,watermarkText:"",watermarkType:"center",countdownDuration:0}}setupEventListeners(){document.getElementById("fullscreenBtn").addEventListener("click",()=>{this.toggleFullscreen()}),document.getElementById("themeBtn").addEventListener("click",()=>{window.themeController.toggleTheme()}),document.getElementById("playBtn").addEventListener("click",()=>{if(!document.getElementById("autoScroll").checked){alert("请先在滚动设置中启用自动滚动功能");return}this.isPlaying?this.pauseReading():this.startCountdownAndPlay()}),document.getElementById("lockBtn").addEventListener("click",()=>{this.toggleTextLock()}),document.getElementById("sidebarToggle").addEventListener("click",()=>{this.toggleSidebar()}),this.setupSettingsPanels(),document.getElementById("importBtn").addEventListener("click",()=>{document.getElementById("fileInput").click()}),document.getElementById("fileInput").addEventListener("change",t=>{window.textController.handleFileImport(t)}),document.addEventListener("keydown",t=>{this.handleKeyboardShortcuts(t)});let e;document.addEventListener("scroll",()=>{this.sidebarHidden||(document.body.classList.add("scrolling"),clearTimeout(e),e=setTimeout(()=>{document.body.classList.remove("scrolling")},1e3))}),document.addEventListener("wheel",t=>{this.handleMouseWheel(t)}),document.addEventListener("click",t=>{!t.target.closest(".settings-panel")&&!t.target.closest(".sidebar-btn")&&this.closeAllPanels()})}setupSidebarBehavior(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarTrigger");document.querySelectorAll(".sidebar-btn:not(.sidebar-toggle)").forEach(o=>{o.addEventListener("mouseenter",()=>{if(!this.sidebarHidden){const i=this.getPanelIdForButton(o.id);i?this.showSettingsPanel(i,o):this.closeAllPanels()}})}),e.addEventListener("mouseleave",()=>{setTimeout(()=>{document.querySelector(".settings-panel:hover")||this.closeAllPanels()},100)}),t.addEventListener("mouseenter",()=>{this.sidebarHidden&&this.showSidebar()})}getPanelIdForButton(e){return{scrollBtn:"scrollSettings",fontBtn:"fontSettings",flipBtn:"flipSettings",watermarkBtn:"watermarkSettings",recordBtn:"recordSettings"}[e]}setupSettingsPanels(){}showSettingsPanel(e,t){this.closeAllPanels();const n=document.getElementById(e);if(!n)return;n.style.display="block",this.activePanel=e;const o=t.getBoundingClientRect();let i=o.right+10,l=o.top;const r=n.offsetHeight||200,s=window.innerHeight;l+r>s&&(l=s-r-20),l<20&&(l=20),n.style.left=`${i}px`,n.style.top=`${l}px`,t.classList.add("active")}toggleSidebar(){document.getElementById("sidebar"),document.getElementById("sidebarTrigger"),document.getElementById("sidebarToggle").querySelector("img"),this.sidebarHidden?this.showSidebar():this.hideSidebar()}showSidebar(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarTrigger"),n=document.querySelector("#sidebarToggle img");this.sidebarHidden=!1,e.classList.remove("hidden"),t.classList.remove("active"),n.src="images/chevron-left.svg",document.getElementById("sidebarToggle").title="隐藏功能区"}hideSidebar(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarTrigger"),n=document.querySelector("#sidebarToggle img");this.sidebarHidden=!0,e.classList.add("hidden"),t.classList.add("active"),n.src="images/chevron-right.svg",document.getElementById("sidebarToggle").title="显示功能区",this.closeAllPanels()}closeAllPanels(){const e=document.querySelectorAll(".settings-panel"),t=document.querySelectorAll(".sidebar-btn");e.forEach(n=>{n.style.display="none"}),t.forEach(n=>{n.classList.remove("active")}),this.activePanel=null}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen().then(()=>{document.body.classList.remove("fullscreen")}):document.documentElement.requestFullscreen().then(()=>{document.body.classList.add("fullscreen")})}startCountdownAndPlay(){this.countdownDuration=parseInt(document.getElementById("countdownDuration").value)||0,this.closeAllPanels(),this.countdownDuration>0?this.showCountdown().then(()=>{this.startReading()}):this.startReading()}startReading(){this.isPlaying=!0,this.updatePlayButton(),window.scrollController&&window.scrollController.startAutoScroll(),window.audioController&&window.audioController.isRecording}pauseReading(){this.isPlaying=!1,this.updatePlayButton(),window.scrollController&&window.scrollController.stopAutoScroll()}updatePlayButton(){const e=document.getElementById("playBtn"),t=e.querySelector("img");this.isPlaying?(t.src="images/pause.svg",e.title="暂停"):(t.src="images/play.svg",e.title="播放/暂停")}showCountdown(){return new Promise(e=>{const t=document.getElementById("countdownDisplay"),n=document.getElementById("countdownText");let o=this.countdownDuration;t.style.display="flex";const i=setInterval(()=>{n.textContent=o,o--,o<0&&(clearInterval(i),t.style.display="none",e())},1e3)})}toggleTextLock(){const e=document.getElementById("textEditor"),t=document.getElementById("lockIcon");this.isLocked=!this.isLocked,this.isLocked?(e.contentEditable=!1,e.classList.add("locked"),t.src="images/lock.svg",document.getElementById("lockBtn").title="解锁文本"):(e.contentEditable=!0,e.classList.remove("locked"),t.src="images/unlock.svg",document.getElementById("lockBtn").title="锁定文本")}handleKeyboardShortcuts(e){e.key==="Escape"&&document.fullscreenElement&&document.exitFullscreen(),e.key===" "&&!e.target.contentEditable&&(e.preventDefault(),this.isPlaying?this.pauseReading():this.startCountdownAndPlay()),e.key==="F11"&&(e.preventDefault(),this.toggleFullscreen())}handleMouseWheel(e){const t=document.getElementById("textEditor"),n=e.deltaY;window.scrollController&&window.scrollController.isAutoScrolling&&(window.scrollController.currentScrollPosition=t.scrollTop+n,t.scrollTop=window.scrollController.currentScrollPosition,this.updateScrollbar())}loadDefaultText(){try{window.textController.setText(`我是一个提词器的示例文本。
你可以直接编辑我，或者粘贴内容。
可以点击左侧功能区的文件夹图标，上传文件。需要是"*.txt"的文本文档格式。
本项目支持翻转(水平、垂直)
在开始使用之前，请注意设置以下内容：字体，字体大小，滚动速度
项目已开源到Github，地址为https://github.com/Song2770/ez4prompt
如果你觉得好用，不妨为我的项目点一颗Star。
如果你遇到了问题，欢迎留言。`),this.updateScrollbar()}catch(e){console.error("加载默认文本失败:",e)}}updateTimeDisplay(){const t=new Date().toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});document.getElementById("timeDisplay").textContent=t}initializeScrollbar(){const e=document.getElementById("textEditor"),t=document.getElementById("customScrollbar"),n=document.getElementById("scrollbarThumb"),o=()=>{const r=e.scrollTop/(e.scrollHeight-e.clientHeight),s=Math.max(20,e.clientHeight/e.scrollHeight*t.clientHeight),c=r*(t.clientHeight-s);n.style.height=`${s}px`,n.style.transform=`translateY(${c}px)`};e.addEventListener("scroll",o);let i=!1,l=!1;n.addEventListener("mousedown",r=>{i=!0;const s=r.clientY,c=e.scrollTop;window.scrollController&&window.scrollController.isAutoScrolling&&(l=!0,window.scrollController.stopAutoScroll());const d=h=>{if(!i)return;const a=(h.clientY-s)/(t.clientHeight-n.clientHeight),f=c+a*(e.scrollHeight-e.clientHeight);e.scrollTop=Math.max(0,Math.min(f,e.scrollHeight-e.clientHeight))},g=()=>{i=!1,l&&window.scrollController&&(window.scrollController.currentScrollPosition=e.scrollTop,window.scrollController.startAutoScroll()),l=!1,document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",g)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",g)}),t.addEventListener("click",r=>{if(r.target===n)return;const c=r.offsetY/t.clientHeight*(e.scrollHeight-e.clientHeight),d=window.scrollController&&window.scrollController.isAutoScrolling;d&&window.scrollController.stopAutoScroll(),window.scrollController?(window.scrollController.smoothScrollTo(c),d&&setTimeout(()=>{window.scrollController&&(window.scrollController.currentScrollPosition=c,window.scrollController.startAutoScroll())},500)):(e.scrollTop=c,d&&window.scrollController&&(window.scrollController.currentScrollPosition=c,window.scrollController.startAutoScroll()))}),setTimeout(o,100),this.updateScrollbar=o}}const p=document.createElement("style");p.textContent=`
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
    }
`;document.head.appendChild(p);document.addEventListener("DOMContentLoaded",()=>{window.app=new x});
